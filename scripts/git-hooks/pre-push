#!/bin/bash

# Git pre-push hook to check cargo fmt and clippy
# This hook will prevent pushing code that is not properly formatted or has clippy warnings

echo "Running code quality checks before push..."

# Check if cargo fmt would make any changes
echo "ğŸ” Checking code formatting..."
if ! cargo fmt --check --quiet; then
    echo "âŒ Code formatting check failed!"
    echo ""
    echo "Please run 'cargo fmt' to format your code before pushing."
    echo "You can also run 'cargo fmt --check' to see what needs formatting."
    echo ""
    echo "Push aborted."
    exit 1
fi
echo "âœ… Code formatting check passed!"

# Check clippy warnings
echo "ğŸ” Checking clippy warnings..."
if ! cargo clippy --all-targets --all-features -- -D warnings; then
    echo "âŒ Clippy check failed!"
    echo ""
    echo "Please fix all clippy warnings before pushing."
    echo "You can run 'cargo clippy --all-targets --all-features -- -D warnings' to see the issues."
    echo ""
    echo "Push aborted."
    exit 1
fi
echo "âœ… Clippy check passed!"

# Source git utility functions
source "$(dirname "$0")/../git-utils.sh"

# Check documentation snippets only if there are changes to .md files in the pushed commits
echo "ğŸ” Checking for Markdown file changes in pushed commits..."

if check_files_changed "md"; then
    echo "ğŸ“ Markdown files changed in pushed commits"
    echo "ğŸ“ Markdown changes detected in push, checking documentation snippets..."
    if ! ./scripts/check-doc-snippets.sh; then
        echo "âŒ Documentation snippets check failed!"
        echo ""
        echo "Please fix the failing documentation examples before pushing."
        echo "You can run './scripts/check-doc-snippets.sh' to see the issues."
        echo ""
        echo "Push aborted."
        exit 1
    fi
    echo "âœ… Documentation snippets check passed!"
else
    echo "ğŸ“ No Markdown file changes in pushed commits, skipping documentation snippets check."
fi

echo "ğŸ‰ All code quality checks passed! Ready to push."
exit 0
